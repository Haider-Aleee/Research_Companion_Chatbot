name: CI/CD Workflow for Deployment to EC2

run-name: >+
    Staging deployment triggered by ${{ github.actor }}
    on branch: ${{ github.ref_name }}
    on event: ${{ github.event_name }}
    on repository: ${{ github.repository }}

on:
  push:
    branches:
      - main
      - master

  workflow_dispatch:

jobs:
  build:
    name: Building the React App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: npm

      - name: Install Frontend dependencies
        run: cd Frontend && npm ci

      - name: Build the React App
        run: cd Frontend && npm run build --if-present

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-app-build-staging
          path: Frontend/build/
          retention-days: 1

  deploy:
    name: Deploying to AWS EC2 Staging Environment
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: react-app-build-staging
          path: Frontend/build/

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2 Staging Instance
        env:
          EC2_STAGING_HOST: ${{ secrets.EC2_STAGING_HOST }}
          EC2_STAGING_USER: ${{ secrets.EC2_STAGING_USER }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          REMOTE_TMP="/tmp/research-deploy-$TIMESTAMP"

          echo "Creating remote temp dir: $REMOTE_TMP"
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_STAGING_USER }}@${{ secrets.EC2_STAGING_HOST }} "mkdir -p $REMOTE_TMP && rm -rf $REMOTE_TMP/*"

          echo "Copying Frontend build to server..."
          scp -i ~/.ssh/deploy_key -r Frontend/build/* ${{ secrets.EC2_STAGING_USER }}@${{ secrets.EC2_STAGING_HOST }}:$REMOTE_TMP/frontend/

          echo "Copying Backend files to server..."
          scp -i ~/.ssh/deploy_key -r Backend/* ${{ secrets.EC2_STAGING_USER }}@${{ secrets.EC2_STAGING_HOST }}:$REMOTE_TMP/backend/

          echo "Finalizing deploy on server (create release, install Python deps, restart service)..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_STAGING_USER }}@${{ secrets.EC2_STAGING_HOST }} << EOF
            set -euo pipefail
            TIMESTAMP="$TIMESTAMP"
            REMOTE_TMP="$REMOTE_TMP"
            DEST="/opt/research-companion/releases/$TIMESTAMP"

            sudo mkdir -p "$DEST"
            sudo rsync -a --delete "$REMOTE_TMP/" "$DEST/"
            sudo chown -R $(whoami):$(whoami) "$DEST" || true
            sudo ln -sfn "$DEST" /opt/research-companion/current

            # Create venv and install backend requirements (if present)
            if [ -f "$DEST/Backend/requirements.txt" ]; then
              cd "$DEST/Backend"
              python3 -m venv venv || true
              . venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            fi

            # Restart systemd service if present
            if sudo systemctl list-units --full -all | grep -q research-companion-backend; then
              sudo systemctl restart research-companion-backend || { echo "failed to restart service"; sudo journalctl -u research-companion-backend -n 200 --no-pager; exit 1; }
            fi
          EOF

      - name: Get EC2 Staging Instance IP
        id: get_ip
        run: |
          echo "instance_ip=${{ secrets.EC2_STAGING_HOST }}" >> $GITHUB_OUTPUT

            
